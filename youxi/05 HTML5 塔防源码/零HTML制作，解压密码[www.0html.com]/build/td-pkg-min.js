var _TD={a:[],init:function(e,f){delete this.init;var d,a={version:"0.1.8.0",is_debug:!!f,is_paused:true,width:16,height:16,show_monster_life:true,fps:0,stage_data:{},defaultSettings:function(){return{step_time:36,grid_size:32,padding:10,global_speed:0.1}},init:function(b){this.obj_board=a.lang.$e(b);this.canvas=this.obj_board.getElementsByTagName("canvas")[0];if(this.canvas.getContext){this.ctx=this.canvas.getContext("2d");this.monster_type_count=a.getDefaultMonsterAttributes();this.iframe=0;this.last_iframe_time=
(new Date).getTime();this.fps=0;this.start()}},start:function(){clearTimeout(this._st);a.log("Start!");var b=this;this.mode="normal";this.eventManager.clear();this.lang.mix(this,this.defaultSettings());this.stage=new a.Stage("stage-main",a.getDefaultStageData("stage_main"));this.canvas.setAttribute("width",this.stage.width);this.canvas.setAttribute("height",this.stage.height);this.canvas.onmousemove=function(c){c=b.getEventXY.call(b,c);b.hover(c[0],c[1])};this.canvas.onclick=function(c){c=b.getEventXY.call(b,
c);b.click(c[0],c[1])};this.is_paused=false;this.stage.start();this.step();return this},checkCheat:function(b){switch(b){case "money+":this.money+=1E6;this.log("cheat success!");break;case "life+":this.life=100;this.log("cheat success!");break;case "life-":this.life=1;this.log("cheat success!");break;case "difficulty+":this.difficulty*=2;this.log("cheat success! difficulty = "+this.difficulty);break;case "difficulty-":this.difficulty/=2;this.log("cheat success! difficulty = "+this.difficulty)}},step:function(){if(this.is_debug&&
_TD&&_TD.cheat){this.checkCheat(_TD.cheat);_TD.cheat=""}if(!this.is_paused){this.iframe++;if(this.iframe%50==0){var b=(new Date).getTime();this.fps=Math.round(5E5/(b-this.last_iframe_time))/10;this.last_iframe_time=b;if(this.fps<23.6&&this.step_time>1)this.step_time--;else this.fps>24.4&&this.step_time++;a.log("FPS: "+this.fps+", Step Time: "+this.step_time)}this.iframe%2400==0&&a.gc();this.stage.step();this.stage.render();var c=this;this._st=setTimeout(function(){c.step()},this.step_time)}},getEventXY:function(b){var c=
a.lang.$e("wrapper");return[b.clientX-c.offsetLeft-this.canvas.offsetLeft+Math.max(document.documentElement.scrollLeft,document.body.scrollLeft),b.clientY-c.offsetTop-this.canvas.offsetTop+Math.max(document.documentElement.scrollTop,document.body.scrollTop)]},hover:function(b,c){this.eventManager.hover(b,c)},click:function(b,c){this.eventManager.click(b,c)},mouseHand:function(b){this.canvas.style.cursor=b?"pointer":"default"},log:function(b){this.is_debug&&window.console&&console.log&&console.log(b)},
gc:function(){if(window.CollectGarbage){CollectGarbage();setTimeout(CollectGarbage,1)}}};for(d=0;this.a[d];d++)this.a[d](a);delete this.a;a.init(e)}};
_TD.a.push(function(e){e.lang={$e:function(f){return document.getElementById(f)},$c:function(f,d,a){f=document.createElement(f);d=d||{};for(var b in d)f.setAttribute(b,d[b]);a&&a.appendChild(f);return f},strLeft:function(f,d){var a=f.slice(0,d),b=a.replace(/[^\x00-\xff]/g,"**").length;if(b<=d)return a;b-=a.length;switch(b){case 0:return a;case d:return f.slice(0,d>>1);default:a=d-b;b=f.slice(a,d);var c=b.replace(/[\x00-\xff]/g,"").length;return c?f.slice(0,a)+this.arguments.callee(b,c):f.slice(0,
a)}},strLen2:function(f){return f.replace(/[^\x00-\xff]/g,"**").length},each:function(f,d){if(Array.prototype.forEach)f.forEach(d);else for(var a=0,b=f.length;a<b;a++)d(f[a])},any:function(f,d){for(var a=0,b=f.length;a<b;a++)if(d(f[a]))return f[a];return null},shift:function(f,d){for(;f[0];)d(f.shift())},rndSort:function(f){return f.concat().sort(function(){return Math.random()-0.5})},_rndRGB2:function(f){f=f.toString(16);return f.length==2?f:"0"+f},rndRGB:function(){var f=Math.floor(Math.random()*
256),d=Math.floor(Math.random()*256);return"#"+this._rndRGB2(Math.floor(Math.random()*256))+this._rndRGB2(f)+this._rndRGB2(d)},rndStr:function(f){f=f||16;var d=[],a,b;for(a=0;a<f;a++){b=Math.floor(Math.random()*36);d.push("1234567890abcdefghijklmnopqrstuvwxyz".substr(b,1))}return d.join("")},nullFunc:function(){},arrayEqual:function(f,d){var a,b=f.length;if(b!=d.length)return false;for(a=0;a<b;a++)if(f[a]!=d[a])return false;return true},mix:function(f,d,a){if(!d||!f)return f;for(var b in d)if(a!==
false||!(b in f))f[b]=d[b];return f}}});
_TD.a.push(function(e){e.eventManager={ex:-1,ey:-1,_registers:{},ontypes:["enter","hover","out","click"],current_type:"hover",isOn:function(f){return this.ex!=-1&&this.ey!=-1&&this.ex>f.x&&this.ex<f.x2&&this.ey>f.y&&this.ey<f.y2},_mkElEvtName:function(f,d){return f.id+"::_evt_::"+d},on:function(f,d,a){this._registers[this._mkElEvtName(f,d)]=[f,d,a]},removeEventListener:function(f,d){delete this._registers[this._mkElEvtName(f,d)]},clear:function(){delete this._registers;this._registers={}},step:function(){if(this.current_type){var f,
d,a,b,c,g=this,h=this.ontypes.length,i,j=[];for(f in this._registers){d=this._registers[f];a=d[0];b=d[1];d=d[2];if(a.is_valid){if(a.is_visiable){i=this.isOn(a);if(this.current_type!="click")if(b=="hover"&&a.is_hover&&i){d();this.current_type="hover"}else if(b=="enter"&&!a.is_hover&&i){a.is_hover=true;d();this.current_type="enter"}else{if(b=="out"&&a.is_hover&&!i){a.is_hover=false;d();this.current_type="out"}}else i&&b=="click"&&d()}}else j.push(a)}e.lang.each(j,function(m){for(c=0;c<h;c++)g.removeEventListener(m,
g.ontypes[c])});this.current_type=""}},hover:function(f,d){if(this.current_type!="click"){this.current_type="hover";this.ex=f;this.ey=d}},click:function(f,d){this.current_type="click";this.ex=f;this.ey=d}}});
_TD.a.push(function(e){e.Stage=function(f,d){this.id=f||"stage-"+e.lang.rndStr();this.cfg=d||{};this.width=this.cfg.width||600;this.height=this.cfg.height||540;this.mode="normal";this.state=0;this.acts=[];this.current_act=null;this._step2=e.lang.nullFunc;this._init()};e.Stage.prototype={_init:function(){typeof this.cfg.init=="function"&&this.cfg.init.call(this);if(typeof this.cfg.step2=="function")this._step2=this.cfg.step2},start:function(){this.state=1;e.lang.each(this.acts,function(f){f.start()})},
pause:function(){this.state=2},gameover:function(){this.current_act.gameover()},clear:function(){this.state=3;e.lang.each(this.acts,function(f){f.clear()})},step:function(){if(!(this.state!=1||!this.current_act)){e.eventManager.step();this.current_act.step();this._step2()}},render:function(){this.state==0||this.state==3||!this.current_act||this.current_act.render()},addAct:function(f){this.acts.push(f)},addElement:function(f,d,a){this.current_act&&this.current_act.addElement(f,d,a)}}});
_TD.a.push(function(e){e.Act=function(f,d){this.stage=f;this.id=d||"act-"+e.lang.rndStr();this.state=0;this.scenes=[];this.end_queue=[];this.current_scene=null;this._init()};e.Act.prototype={_init:function(){this.stage.addAct(this)},start:function(){if(this.stage.current_act&&this.stage.current_act.state!=3){this.state=0;this.stage.current_act.queue(this.start)}else{this.state=1;this.stage.current_act=this;e.lang.each(this.scenes,function(f){f.start()})}},pause:function(){this.state=2},end:function(){this.state=
3;for(var f;f=this.end_queue.shift();)f();this.stage.current_act=null},queue:function(f){this.end_queue.push(f)},clear:function(){this.state=3;e.lang.each(this.scenes,function(f){f.clear()})},step:function(){this.state!=1||!this.current_scene||this.current_scene.step()},render:function(){this.state==0||this.state==3||!this.current_scene||this.current_scene.render()},addScene:function(f){this.scenes.push(f)},addElement:function(f,d,a){this.current_scene&&this.current_scene.addElement(f,d,a)},gameover:function(){this.current_scene.gameover()}}});
_TD.a.push(function(e){e.Scene=function(f,d){this.act=f;this.stage=f.stage;this.is_gameover=false;this.id=d||"scene-"+e.lang.rndStr();this.state=0;this.end_queue=[];this._step_elements=[[],[],[]];this._render_elements=[[],[],[],[],[],[],[],[],[],[]];this._init()};e.Scene.prototype={_init:function(){this.act.addScene(this);this.wave=0},start:function(){if(this.act.current_scene&&this.act.current_scene!=this&&this.act.current_scene.state!=3){this.state=0;this.act.current_scene.queue(this.start)}else{this.state=
1;this.act.current_scene=this}},pause:function(){this.state=2},end:function(){this.state=3;for(var f;f=this.end_queue.shift();)f();this.clear();this.act.current_scene=null},clear:function(){e.lang.shift(this._step_elements,function(f){e.lang.shift(f,function(d){d.del()})});e.lang.shift(this._render_elements,function(f){e.lang.shift(f,function(d){d.del()})})},queue:function(f){this.end_queue.push(f)},gameover:function(){if(!this.is_gameover){this.pause();this.is_gameover=true}},step:function(){if(this.state==
1){if(e.life<=0){e.life=0;this.gameover()}var f,d;for(f=0;f<3;f++){d=[];e.lang.shift(this._step_elements[f],function(a){if(a.is_valid){a.is_paused||a.step();d.push(a)}else setTimeout(function(){a=null},500)});this._step_elements[f]=d}}},render:function(){if(!(this.state==0||this.state==3)){var f,d;e.ctx.clearRect(0,0,this.stage.width,this.stage.height);for(f=0;f<10;f++){d=[];e.lang.shift(this._render_elements[f],function(a){if(a.is_valid){a.is_visiable&&a.render();d.push(a)}});this._render_elements[f]=
d}this.is_gameover&&this.panel.gameover_obj.show()}},addElement:function(f,d,a){d=d||f.step_level||1;a=a||f.render_level;this._step_elements[d].push(f);this._render_elements[a].push(f);f.scene=this;f.step_level=d;f.render_level=a}}});
_TD.a.push(function(e){e.Element=function(f,d){this.id=f||"el-"+e.lang.rndStr();this.cfg=d||{};this.is_valid=true;this.is_visiable=typeof d.is_visiable!="undefined"?d.is_visiable:true;this.is_hover=this.is_paused=false;this.x=this.cfg.x||-1;this.y=this.cfg.y||-1;this.width=this.cfg.width||0;this.height=this.cfg.height||0;this.step_level=d.step_level||1;this.render_level=d.render_level;this.on_events=d.on_events||[];this._init()};e.Element.prototype={_init:function(){var f=this,d,a,b;d=0;for(b=this.on_events.length;d<
b;d++){a=this.on_events[d];switch(a){case "enter":this.on("enter",function(){f.onEnter()});break;case "out":this.on("out",function(){f.onOut()});break;case "hover":this.on("hover",function(){f.onHover()});break;case "click":this.on("click",function(){f.onClick()})}}this.caculatePos()},caculatePos:function(){this.cx=this.x+this.width/2;this.cy=this.y+this.height/2;this.x2=this.x+this.width;this.y2=this.y+this.height},start:function(){this.is_paused=false},pause:function(){this.is_paused=true},hide:function(){this.is_visiable=
false},show:function(){this.is_visiable=true},del:function(){this.is_valid=false},on:function(f,d){e.eventManager.on(this,f,d)},onEnter:e.lang.nullFunc,onOut:e.lang.nullFunc,onHover:e.lang.nullFunc,onClick:e.lang.nullFunc,step:e.lang.nullFunc,render:e.lang.nullFunc,addToScene:function(f,d,a,b){this.scene=f;if(!isNaN(d)){this.step_level=d||this.step_level;this.render_level=a||this.render_level;b&&e.lang.each(b,function(c){f.addElement(c,d,a)});f.addElement(this,d,a)}}}});
_TD.a.push(function(e){function f(c,g){var h=new e.Element(c,g);e.lang.mix(h,b);h._init(g);return h}var d={_init:function(c){c=c||{};this.grid_x=c.grid_x||10;this.grid_y=c.grid_y||10;this.x=c.x||0;this.y=c.y||0;this.width=this.grid_x*e.grid_size;this.height=this.grid_y*e.grid_size;this.x2=this.x+this.width;this.y2=this.y+this.width;this.grids=[];this.entrance=this.exit=null;this.buildings=[];this.monsters=[];this.bullets=[];this.scene=c.scene;this.is_main_map=!!c.is_main_map;this.select_hl=e.MapSelectHighLight(this.id+
"-hl",{map:this});this.select_hl.addToScene(this.scene,1,9);this.selected_building=null;this._wait_clearInvalidElements=20;this._wait_add_monsters=0;this._wait_add_monsters_arr=[];if(this.is_main_map){this.mmm=new f(this.id+"-mmm",{map:this});this.mmm.addToScene(this.scene,1,7)}var g,h=this.grid_x*this.grid_y,i=c.grid_data||[],j;for(g=0;g<h;g++){j=i[g]||{};j.mx=g%this.grid_x;j.my=Math.floor(g/this.grid_x);j.map=this;j.step_level=this.step_level;j.render_level=this.render_level;j=new e.Grid(this.id+
"-grid-"+j.mx+"-"+j.my,j);this.grids.push(j)}if(c.entrance&&c.exit&&!e.lang.arrayEqual(c.entrance,c.exit)){this.entrance=this.getGrid(c.entrance[0],c.entrance[1]);this.entrance.is_entrance=true;this.exit=this.getGrid(c.exit[0],c.exit[1]);this.exit.is_exit=true}var m=this;c.grids_cfg&&e.lang.each(c.grids_cfg,function(k){var l=m.getGrid(k.pos[0],k.pos[1]);if(l){if(!isNaN(k.passable_flag))l.passable_flag=k.passable_flag;if(!isNaN(k.build_flag))l.build_flag=k.build_flag;k.building&&l.addBuilding(k.building)}})},
checkHasWeapon:function(){this.has_weapon=this.anyBuilding(function(c){return c.is_weapon})!=null},getGrid:function(c,g){return this.grids[g*this.grid_x+c]},anyMonster:function(c){return e.lang.any(this.monsters,c)},anyBuilding:function(c){return e.lang.any(this.buildings,c)},anyBullet:function(c){return e.lang.any(this.bullets,c)},eachBuilding:function(c){e.lang.each(this.buildings,c)},eachMonster:function(c){e.lang.each(this.monsters,c)},eachBullet:function(c){e.lang.each(this.bullets,c)},preBuild:function(c){e.mode=
"build";this.pre_building&&this.pre_building.remove();this.pre_building=new e.Building(this.id+"-pre-building-"+e.lang.rndStr(),{type:c,map:this,is_pre_building:true});this.scene.addElement(this.pre_building,1,this.render_level+1)},cancelPreBuild:function(){e.mode="normal";this.pre_building&&this.pre_building.remove()},clearInvalidElements:function(){if(this._wait_clearInvalidElements>0)this._wait_clearInvalidElements--;else{this._wait_clearInvalidElements=20;var c=[];e.lang.shift(this.buildings,
function(g){g.is_valid&&c.push(g)});this.buildings=c;c=[];e.lang.shift(this.monsters,function(g){g.is_valid&&c.push(g)});this.monsters=c;c=[];e.lang.shift(this.bullets,function(g){g.is_valid&&c.push(g)});this.bullets=c}},addMonster:function(c){if(this.entrance){if(typeof c=="number")c=new e.Monster(null,{idx:c,difficulty:e.difficulty,step_level:this.step_level,render_level:this.render_level+2});this.entrance.addMonster(c)}},addMonsters:function(c,g){this._wait_add_monsters=c;this._wait_add_monsters_objidx=
g},addMonsters2:function(c){this._wait_add_monsters_arr=c},checkPassable:function(c,g){var h=this.getGrid(c,g);return h!=null&&h.passable_flag==1&&h.build_flag!=2},step:function(){this.clearInvalidElements();if(this._wait_add_monsters>0){this.addMonster(this._wait_add_monsters_objidx);this._wait_add_monsters--}else if(this._wait_add_monsters_arr.length>0){var c=this._wait_add_monsters_arr.shift();this.addMonsters(c[0],c[1])}},render:function(){var c=e.ctx;c.strokeStyle="#999";c.lineWidth=1;c.beginPath();
c.strokeRect(this.x+0.5,this.y+0.5,this.width,this.height);c.closePath();c.stroke()},onOut:function(){this.is_main_map&&this.pre_building&&this.pre_building.hide()}};e.Map=function(c,g){g.on_events=["enter","out"];var h=new e.Element(c,g);e.lang.mix(h,d);h._init(g);return h};var a={_init:function(c){this.map=c.map;this.width=e.grid_size+2;this.height=e.grid_size+2;this.is_visiable=false},show:function(c){this.x=c.x;this.y=c.y;this.is_visiable=true},render:function(){var c=e.ctx;c.lineWidth=2;c.strokeStyle=
"#f93";c.beginPath();c.strokeRect(this.x,this.y,this.width-1,this.height-1);c.closePath();c.stroke()}};e.MapSelectHighLight=function(c,g){var h=new e.Element(c,g);e.lang.mix(h,a);h._init(g);return h};var b={_init:function(c){this.map=c.map;this.x1=this.map.x;this.y1=this.map.y;this.x2=this.map.x2+1;this.y2=this.map.y2+1;this.w=this.map.scene.stage.width;this.h=this.map.scene.stage.height;this.w2=this.w-this.x2;this.h2=this.h-this.y2},render:function(){var c=e.ctx;c.fillStyle="#fff";c.beginPath();
c.fillRect(0,0,this.x1,this.h);c.fillRect(0,0,this.w,this.y1);c.fillRect(0,this.y2,this.w,this.h2);c.fillRect(this.x2,0,this.w2,this.h);c.closePath();c.fill()}}});
_TD.a.push(function(e){var f={_init:function(d){d=d||{};this.map=d.map;this.scene=this.map.scene;this.mx=d.mx;this.my=d.my;this.height=this.width=e.grid_size;this.is_entrance=this.is_exit=false;this.build_flag=this.passable_flag=1;this.building=null;this.caculatePos()},caculatePos:function(){this.x=this.map.x+this.mx*e.grid_size;this.y=this.map.y+this.my*e.grid_size;this.x2=this.x+e.grid_size;this.y2=this.y+e.grid_size;this.cx=Math.floor(this.x+e.grid_size/2);this.cy=Math.floor(this.y+e.grid_size/
2)},checkBlock:function(){if(this.is_entrance||this.is_exit)return true;var d=this;return(new e.FindWay(this.map.grid_x,this.map.grid_y,this.map.entrance.mx,this.map.entrance.my,this.map.exit.mx,this.map.exit.my,function(a,b){return!(a==d.mx&&b==d.my)&&d.map.checkPassable(a,b)})).is_blocked},buyBuilding:function(d){var a=e.getDefaultBuildingAttributes(d).cost||0;if(e.money>=a){e.money-=a;this.addBuilding(d)}else{e.log(e._t("not_enough_money",[a]));this.scene.panel.balloontip.msg(e._t("not_enough_money",
[a]),this)}},addBuilding:function(d){this.building&&this.removeBuilding();d=new e.Building("building-"+d+"-"+e.lang.rndStr(),{type:d,step_level:this.step_level,render_level:this.render_level});d.locate(this);this.scene.addElement(d,this.step_level,this.render_level+1);this.map.buildings.push(d);this.building=d;this.build_flag=2;this.map.checkHasWeapon();this.map.pre_building&&this.map.pre_building.hide()},removeBuilding:function(){if(this.building){this.building.remove();this.build_flag=1}},addMonster:function(d){d.beAddToGrid(this);
this.map.monsters.push(d);d.start()},hightLight:function(d){this.map.select_hl[d?"show":"hide"](this)},render:function(){var d=e.ctx,a=this.x+0.5,b=this.y+0.5;if(this.is_hover){d.fillStyle="rgba(255, 255, 200, 0.2)";d.beginPath();d.fillRect(a,b,this.width,this.height);d.closePath();d.fill()}if(this.passable_flag==0){d.fillStyle="#fcc";d.beginPath();d.fillRect(a,b,this.width,this.height);d.closePath();d.fill()}if(this.is_entrance||this.is_exit){d.lineWidth=1;d.fillStyle="#ccc";d.beginPath();d.fillRect(a,
b,this.width,this.height);d.closePath();d.fill();d.strokeStyle="#666";d.fillStyle=this.is_entrance?"#fff":"#666";d.beginPath();d.arc(this.cx,this.cy,e.grid_size*0.325,0,Math.PI*2,true);d.closePath();d.fill();d.stroke()}d.strokeStyle="#eee";d.lineWidth=1;d.beginPath();d.strokeRect(a,b,this.width,this.height);d.closePath();d.stroke()},onEnter:function(){if(this.map.is_main_map&&e.mode=="build")if(this.build_flag==1){this.map.pre_building.show();this.map.pre_building.locate(this)}else this.map.pre_building.hide();
else if(this.map.is_main_map){var d="";if(this.is_entrance)d=e._t("entrance");else if(this.is_exit)d=e._t("exit");else if(this.passable_flag==0)d=e._t("_cant_pass");else if(this.build_flag==0)d=e._t("_cant_build");d&&this.scene.panel.balloontip.msg(d,this)}},onOut:function(){this.scene.panel.balloontip.el==this&&this.scene.panel.balloontip.hide()},onClick:function(){if(this.scene.state==1)if(e.mode=="build"&&this.map.is_main_map&&!this.building)this.checkBlock()?this.scene.panel.balloontip.msg(e._t("blocked"),
this):this.buyBuilding(this.map.pre_building.type);else if(!this.building&&this.map.selected_building){this.map.selected_building.toggleSelected();this.map.selected_building=null}}};e.Grid=function(d,a){a.on_events=["enter","out","click"];var b=new e.Element(d,a);e.lang.mix(b,f);b._init(a);return b}});
_TD.a.push(function(e){var f={_init:function(a){this.is_selected=false;this.killed=this.level=0;this.target=null;a=a||{};this.map=a.map||null;this.grid=a.grid||null;this.bullet_type=a.bullet_type||1;this.type=a.type;this.speed=a.speed;this.bullet_speed=a.bullet_speed;this.blink=this.is_pre_building=!!a.is_pre_building;this.wait_blink=this._default_wait_blink=20;this.is_weapon=this.type!="wall";a=e.getDefaultBuildingAttributes(this.type);e.lang.mix(this,a);this.range_px=this.range*e.grid_size;this.money=
this.cost;this.caculatePos()},getUpgradeCost:function(){return Math.floor(this.money*0.75)},getSellMoney:function(){return Math.floor(this.money*0.5)||1},toggleSelected:function(){this.is_selected=!this.is_selected;this.grid.hightLight(this.is_selected);var a=this;if(this.is_selected){this.map.eachBuilding(function(b){b.is_selected=b==a});(this.map.is_main_map?this.scene.panel_map:this.scene.map).eachBuilding(function(b){b.is_selected=false;b.grid.hightLight(false)});this.map.selected_building=this;
this.map.is_main_map?this.scene.map.cancelPreBuild():this.scene.map.preBuild(this.type)}else{if(this.map.selected_building==this)this.map.selected_building=null;this.map.is_main_map||this.scene.map.cancelPreBuild()}if(this.map.is_main_map)if(this.map.selected_building){this.scene.panel.btn_upgrade.show();this.scene.panel.btn_sell.show();this.updateBtnDesc()}else{this.scene.panel.btn_upgrade.hide();this.scene.panel.btn_sell.hide()}},updateBtnDesc:function(){this.scene.panel.btn_upgrade.desc=e._t("upgrade",
[e._t("building_name_"+this.type),this.level+1,this.getUpgradeCost()]);this.scene.panel.btn_sell.desc=e._t("sell",[e._t("building_name_"+this.type),this.getSellMoney()])},locate:function(a){this.grid=a;this.map=a.map;this.cx=this.grid.cx;this.cy=this.grid.cy;this.x=this.grid.x;this.y=this.grid.y;this.x2=this.grid.x2;this.y2=this.grid.y2;this.width=this.grid.width;this.height=this.grid.height;this.px=this.x+0.5;this.py=this.y+0.5;this.wait_blink=this._default_wait_blink;this._fire_wait2=this._fire_wait=
Math.floor(Math.max(2/(this.speed*e.global_speed),1))},remove:function(){if(this.grid)this.grid.building=null;this.hide();this.del()},findTaget:function(){if(!(!this.is_weapon||this.is_pre_building||!this.grid)){var a=this.cx,b=this.cy,c=Math.pow(this.range_px,2);if(!(this.target&&this.target.is_valid&&Math.pow(this.target.cx-a,2)+Math.pow(this.target.cy-b,2)<=c))this.target=e.lang.any(e.lang.rndSort(this.map.monsters),function(g){return Math.pow(g.cx-a,2)+Math.pow(g.cy-b,2)<=c})}},getTargetPosition:function(){if(!this.target){var a=
this.map.is_main_map?this.map.entrance:this.grid;return[a.cx,a.cy]}return[this.target.cx,this.target.cy]},fire:function(){if(this.target&&this.target.is_valid)if(this.type=="laser_gun")this.target.beHit(this,this.damage);else{var a=this.muzzle||[this.cx,this.cy];new e.Bullet(null,{building:this,damage:this.damage,target:this.target,speed:this.bullet_speed,x:a[0],y:a[1]})}},tryToFire:function(){if(this.is_weapon&&this.target){this._fire_wait--;if(!(this._fire_wait>0))if(this._fire_wait<0)this._fire_wait=
this._fire_wait2;else this.fire()}},_upgrade2:function(a){this._upgrade_records[a]||(this._upgrade_records[a]=this[a]);var b=this._upgrade_records[a],c="max_"+a,g=this["_update_rule_"+a]||e.default_upgrade_rule;if(!(!b||isNaN(b))){b=g(this.level,b);if(this[c]&&!isNaN(this[c])&&this[c]<b)b=this[c];this._upgrade_records[a]=b;this[a]=Math.floor(b)}},upgrade:function(){if(!this._upgrade_records)this._upgrade_records={};var a=["damage","range","speed","life","shield"],b;for(b=0;b<a.length;b++)this._upgrade2(a[b]);
this.level++;this.range_px=this.range*e.grid_size},tryToUpgrade:function(a){var b=this.getUpgradeCost(),c="";if(b>e.money)c=e._t("not_enough_money",[b]);else{e.money-=b;this.money+=b;this.upgrade();c=e._t("upgrade_success",[e._t("building_name_"+this.type),this.level,this.getUpgradeCost()])}this.updateBtnDesc();this.scene.panel.balloontip.msg(c,a)},tryToSell:function(){if(this.is_valid){e.money+=this.getSellMoney();this.is_valid=false;this.grid.removeBuilding();this.map.selected_building=null;this.map.select_hl.hide();
this.map.checkHasWeapon();this.scene.panel.btn_upgrade.hide();this.scene.panel.btn_sell.hide();this.scene.panel.balloontip.hide()}},step:function(){if(this.blink){this.wait_blink--;if(this.wait_blink<-this._default_wait_blink)this.wait_blink=this._default_wait_blink}this.findTaget();this.tryToFire()},render:function(){if(!(!this.is_visiable||this.wait_blink<0)){var a=e.ctx;e.renderBuilding(this);if(this.map.is_main_map&&(this.is_selected||this.is_pre_building||this.map.show_all_ranges)&&this.is_weapon&&
this.range>0&&this.grid){a.lineWidth=1;a.fillStyle="rgba(200, 200, 200, 0.15)";a.strokeStyle="#999";a.beginPath();a.arc(this.cx,this.cy,this.range_px,0,Math.PI*2,true);a.closePath();a.fill();a.stroke()}if(this.type=="laser_gun"&&this.target&&this.target.is_valid){a.lineWidth=3;a.strokeStyle="rgba(50, 50, 200, 0.5)";a.beginPath();a.moveTo(this.cx,this.cy);a.lineTo(this.target.cx,this.target.cy);a.closePath();a.stroke();a.lineWidth=1;a.strokeStyle="rgba(150, 150, 255, 0.5)";a.beginPath();a.lineTo(this.cx,
this.cy);a.closePath();a.stroke()}}},onEnter:function(){if(!this.is_pre_building){var a="\u5efa\u7b51\u5de5\u4e8b";a=this.map.is_main_map?e._t("building_info"+(this.type=="wall"?"_wall":""),[e._t("building_name_"+this.type),this.level,this.damage,this.speed,this.range,this.killed]):e._t("building_intro_"+this.type,[e.getDefaultBuildingAttributes(this.type).cost]);this.scene.panel.balloontip.msg(a,this.grid)}},onOut:function(){this.scene.panel.balloontip.grid==this.grid&&this.scene.panel.balloontip.hide()},
onClick:function(){this.is_pre_building||this.scene.state!=1||this.toggleSelected()}};e.Building=function(a,b){b.on_events=["enter","out","click"];var c=new e.Element(a,b);e.lang.mix(c,f);c._init(b);return c};var d={_init:function(a){a=a||{};this.speed=a.speed;this.damage=a.damage;this.target=a.target;this.cx=a.x;this.cy=a.y;this.r=a.r||Math.max(Math.sqrt(this.damage),2);if(this.r<1)this.r=1;if(this.r>6)this.r=6;this.building=a.building||null;this.map=a.map||this.building.map;this.type=a.type||1;
this.color=a.color||"#000";this.map.bullets.push(this);this.addToScene(this.map.scene,1,6);this.type==1&&this.caculate()},caculate:function(){var a,b,c;b=this.target.cy;var g;a=this.target.cx-this.cx;b=b-this.cy;c=Math.sqrt(Math.pow(a,2)+Math.pow(b,2));g=20*this.speed*e.global_speed;this.vx=a*g/c;this.vy=b*g/c},checkOutOfMap:function(){this.is_valid=!(this.cx<this.map.x||this.cx>this.map.x2||this.cy<this.map.y||this.cy>this.map.y2);return!this.is_valid},checkHit:function(){var a=this.cx,b=this.cy,
c=this.r,g=this.map.anyMonster(function(h){return Math.pow(h.cx-a,2)+Math.pow(h.cy-b,2)<=Math.pow(h.r+c,2)*2});if(g){g.beHit(this.building,this.damage);this.is_valid=false;return true}return false},step:function(){if(!(this.checkOutOfMap()||this.checkHit())){this.cx+=this.vx;this.cy+=this.vy}},render:function(){var a=e.ctx;a.fillStyle=this.color;a.beginPath();a.arc(this.cx,this.cy,this.r,0,Math.PI*2,true);a.closePath();a.fill()}};e.Bullet=function(a,b){var c=new e.Element(a,b);e.lang.mix(c,d);c._init(b);
return c}});
_TD.a.push(function(e){var f={_init:function(d){d=d||{};this.idx=d.idx||1;this.difficulty=d.difficulty||1;var a=e.getDefaultMonsterAttributes(this.idx);this.speed=Math.floor((a.speed+this.difficulty-1)*(Math.random()*0.5+0.75));if(this.speed<1)this.speed=1;if(this.speed>d.max_speed)this.speed=d.max_speed;this.life=this.life0=Math.floor(a.life*this.difficulty*(Math.random()+0.5));if(this.life<1)this.life=this.life0=1;this.shield=Math.floor(a.shield+Math.sqrt(this.difficulty)-1);if(this.shield<0)this.shield=
0;this.damage=Math.floor((a.damage||1)*(0.5+Math.random()));if(this.damage<1)this.damage=1;this.money=a.money||Math.floor(Math.sqrt((this.speed+this.life)*(this.shield+1)*this.damage));if(this.money<1)this.money=1;this.color=a.color||e.lang.rndRGB();this.r=this.damage;if(this.r<4)this.r=4;if(this.r>e.grid_size/2-4)this.r=e.grid_size/2-4;this.render=a.render;this.next_grid=this.map=this.grid=null;this.way=[];this.toward=2;this._dy=this._dx=0;this.is_blocked=false},caculatePos:function(){},beHit:function(d,
a){if(this.is_valid){a-=this.shield;if(a<=0)a=1;this.life-=a;e.score+=Math.min(Math.floor(Math.sqrt(a)),1);this.life<0&&this.beKilled(d)}},beKilled:function(d){if(this.is_valid){this.life=0;this.is_valid=false;e.money+=this.money;d.killed++}},arrive:function(){this.grid=this.next_grid;this.next_grid=null;this.checkFinish()},findWay:function(){var d=this,a=new e.FindWay(this.map.grid_x,this.map.grid_y,this.grid.mx,this.grid.my,this.map.exit.mx,this.map.exit.my,function(b,c){return d.map.checkPassable(b,
c)});this.way=a.way;delete a},checkFinish:function(){if(this.grid&&this.map&&this.grid==this.map.exit){e.life-=this.damage;e.wave_damage+=this.damage;if(e.life<=0){e.life=0;e.stage.gameover()}else{this.pause();this.del()}}},beAddToGrid:function(d){this.grid=d;this.map=d.map;this.cx=d.cx;this.cy=d.cy;this.grid.scene.addElement(this)},getToward:function(){if(this.grid&&this.next_grid)if(this.grid.my<this.next_grid.my)this.toward=0;else if(this.grid.mx<this.next_grid.mx)this.toward=1;else if(this.grid.my>
this.next_grid.my)this.toward=2;else if(this.grid.mx>this.next_grid.mx)this.toward=3},getNextGrid:function(){if(this.way.length==0||Math.random()<0.1)this.findWay();var d=this.way.shift();if(d&&!this.map.checkPassable(d[0],d[1])){this.findWay();d=this.way.shift()}if(d)this.next_grid=this.map.getGrid(d[0],d[1])},beBlocked:function(){if(!this.is_blocked){this.is_blocked=true;e.log("monster be blocked!")}},step:function(){if(!(!this.is_valid||this.is_paused||!this.grid)){if(!this.next_grid){this.getNextGrid();
if(!this.next_grid){this.beBlocked();return}}if(this.cx==this.next_grid.cx&&this.cy==this.next_grid.cy)this.arrive();else{var d=this.next_grid.cx-this.cx,a=this.next_grid.cy-this.cy,b=d<0?-1:1,c=a<0?-1:1,g=this.speed*e.global_speed;if(Math.abs(d)<g&&Math.abs(a)<g){this.cx=this.next_grid.cx;this.cy=this.next_grid.cy;this._dx=g-Math.abs(d);this._dy=g-Math.abs(a)}else{this.cx+=d==0?0:b*(g+this._dx);this.cy+=a==0?0:c*(g+this._dy);this._dy=this._dx=0}}}}};e.Monster=function(d,a){var b=new e.Element(d,
a);e.lang.mix(b,f);b._init(a);return b}});
_TD.a.push(function(e){var f={_init:function(c){c=c||{};this.x=c.x;this.y=c.y;this.scene=c.scene;this.map=c.main_map;c=new e.Map("panel-map",e.lang.mix({x:this.x+c.map.x,y:this.y+c.map.y,scene:this.scene,step_level:this.step_level,render_level:this.render_level},c.map,false));this.addToScene(this.scene,1,7);c.addToScene(this.scene,1,7,c.grids);this.scene.panel_map=c;this.gameover_obj=new e.GameOver("panel-gameover",{panel:this,scene:this.scene,step_level:this.step_level,is_visiable:false,x:0,y:0,
width:this.scene.stage.width,height:this.scene.stage.height,render_level:9});this.balloontip=new e.BalloonTip("panel-balloon-tip",{scene:this.scene,step_level:this.step_level,render_level:9});this.balloontip.addToScene(this.scene,1,9);this.btn_pause=new e.Button("panel-btn-pause",{scene:this.scene,x:this.x,y:this.y+260,text:e._t("button_pause_text"),step_level:this.step_level,render_level:this.render_level+1,onClick:function(){if(this.scene.state==1){this.scene.pause();this.text=e._t("button_continue_text");
this.scene.panel.btn_upgrade.hide();this.scene.panel.btn_sell.hide();this.scene.panel.btn_restart.show()}else if(this.scene.state==2){this.scene.start();this.text=e._t("button_pause_text");this.scene.panel.btn_restart.hide();if(this.scene.map.selected_building){this.scene.panel.btn_upgrade.show();this.scene.panel.btn_sell.show()}}}});this.btn_restart=new e.Button("panel-btn-restart",{scene:this.scene,x:this.x,y:this.y+300,is_visiable:false,text:e._t("button_restart_text"),step_level:this.step_level,
render_level:this.render_level+1,onClick:function(){setTimeout(function(){e.stage.clear();e.is_paused=true;e.start();e.mouseHand(false)},0)}});this.btn_upgrade=new e.Button("panel-btn-upgrade",{scene:this.scene,x:this.x,y:this.y+300,is_visiable:false,text:e._t("button_upgrade_text"),step_level:this.step_level,render_level:this.render_level+1,onClick:function(){this.scene.map.selected_building.tryToUpgrade(this)}});this.btn_sell=new e.Button("panel-btn-sell",{scene:this.scene,x:this.x,y:this.y+340,
is_visiable:false,text:e._t("button_sell_text"),step_level:this.step_level,render_level:this.render_level+1,onClick:function(){this.scene.map.selected_building.tryToSell(this)}})},render:function(){var c=e.ctx;c.textAlign="left";c.textBaseline="top";c.fillStyle="#000";c.font="normal 12px 'Courier New'";c.beginPath();c.fillText(e._t("panel_money_title")+e.money,this.x,this.y);c.fillText(e._t("panel_score_title")+e.score,this.x,this.y+20);c.fillText(e._t("panel_life_title")+e.life,this.x,this.y+40);
c.fillText(e._t("panel_building_title")+this.map.buildings.length,this.x,this.y+60);c.fillText(e._t("panel_monster_title")+this.map.monsters.length,this.x,this.y+80);c.fillText(e._t("wave_info",[this.scene.wave]),this.x,this.y+210);c.closePath();c.textAlign="right";c.fillStyle="#666";c.font="normal 12px 'Courier New'";c.beginPath();c.fillText("version: "+e.version+" | oldj.net",e.stage.width-e.padding,e.stage.height-e.padding*2);c.closePath();c.textAlign="left";c.fillStyle="#666";c.font="normal 12px 'Courier New'";
c.beginPath();c.fillText("FPS: "+e.fps,e.padding,e.stage.height-e.padding*2);c.closePath()}};e.Panel=function(c,g){var h=new e.Element(c,g);e.lang.mix(h,f);h._init(g);return h};var d={_init:function(c){c=c||{};this.scene=c.scene},msg:function(c,g){this.text=c;var h=e.ctx;h.font="normal 12px 'Courier New'";this.width=Math.max(h.measureText(c).width+10,e.lang.strLen2(c)*6+10);this.height=23;if(g&&g.cx&&g.cy){this.el=g;this.x=g.cx+0.5;this.y=g.cy+0.5;if(this.x+this.width>this.scene.stage.width-e.padding)this.x-=
this.width;this.px=this.x+5;this.py=this.y+4;this.show()}},render:function(){if(this.el){var c=e.ctx;c.lineWidth=1;c.fillStyle="rgba(255, 255, 0, 0.5)";c.strokeStyle="rgba(222, 222, 0, 0.9)";c.beginPath();c.rect(this.x,this.y,this.width,this.height);c.closePath();c.fill();c.stroke();c.textAlign="left";c.textBaseline="top";c.fillStyle="#000";c.font="normal 12px 'Courier New'";c.beginPath();c.fillText(this.text,this.px,this.py);c.closePath()}}};e.BalloonTip=function(c,g){var h=new e.Element(c,g);e.lang.mix(h,
d);h._init(g);return h};var a={_init:function(c){c=c||{};this.text=c.text;this.onClick=c.onClick||e.lang.nullFunc;this.x=c.x;this.y=c.y;this.width=c.width||80;this.height=c.height||30;this.font_x=this.x+8;this.font_y=this.y+7;this.scene=c.scene;this.desc=c.desc||"";this.addToScene(this.scene,this.step_level,this.render_level);this.caculatePos()},onEnter:function(){e.mouseHand(true);this.desc&&this.scene.panel.balloontip.msg(this.desc,this)},onOut:function(){e.mouseHand(false);this.scene.panel.balloontip.el==
this&&this.scene.panel.balloontip.hide()},render:function(){var c=e.ctx;c.lineWidth=2;c.fillStyle=this.is_hover?"#eee":"#ccc";c.strokeStyle="#999";c.beginPath();c.rect(this.x,this.y,this.width,this.height);c.closePath();c.fill();c.stroke();c.textAlign="left";c.textBaseline="top";c.fillStyle="#000";c.font="normal 12px 'Courier New'";c.beginPath();c.fillText(this.text,this.font_x,this.font_y);c.closePath();c.fill()}};e.Button=function(c,g){g.on_events=["enter","out","click"];var h=new e.Element(c,g);
e.lang.mix(h,a);h._init(g);return h};var b={_init:function(c){this.panel=c.panel;this.scene=c.scene;this.addToScene(this.scene,1,9)},render:function(){this.panel.btn_pause.hide();this.panel.btn_upgrade.hide();this.panel.btn_sell.hide();this.panel.btn_restart.show();var c=e.ctx;c.textAlign="center";c.textBaseline="middle";c.fillStyle="#ccc";c.font="bold 62px 'Verdana'";c.beginPath();c.fillText("GAME OVER",this.width/2,this.height/2);c.closePath();c.fillStyle="#f00";c.font="bold 60px 'Verdana'";c.beginPath();
c.fillText("GAME OVER",this.width/2,this.height/2);c.closePath()}};e.GameOver=function(c,g){var h=new e.Element(c,g);e.lang.mix(h,b);h._init(g);return h}});
_TD.a.push(function(e){var f=function(){var a=new e.Act(this,"act-1");a=new e.Scene(a,"scene-1");var b=e.getDefaultStageData("scene_endless");this.config=b.config;e.life=this.config.life;e.money=this.config.money;e.score=this.config.score;e.difficulty=this.config.difficulty;e.wave_damage=this.config.wave_damage;var c=new e.Map("main-map",e.lang.mix({scene:a,is_main_map:true,step_level:1,render_level:2},b.map));c.addToScene(a,1,2,c.grids);a.map=c;a.panel=new e.Panel("panel",e.lang.mix({scene:a,main_map:c,
step_level:1,render_level:7},b.panel));this.newWave=b.newWave;this.map=c;this.wait_new_wave=this.config.wait_new_wave},d=function(){var a=this.current_act.current_scene,b=a.wave;if(!(b==0&&!this.map.has_weapon||a.state!=1))if(this.map.monsters.length==0)if(this.wait_new_wave>0)this.wait_new_wave--;else{this.wait_new_wave=this.config.wait_new_wave;b++;a.wave=b;this.newWave({map:this.map,wave:b})}};e.getDefaultStageData=function(a){return{stage_main:{width:640,height:560,init:f,step2:d},scene_endless:{map:{grid_x:16,
grid_y:16,x:e.padding,y:e.padding,entrance:[0,0],exit:[15,15],grids_cfg:[{pos:[3,3],passable_flag:0},{pos:[7,15],build_flag:0},{pos:[4,12],building:"wall"},{pos:[4,13],building:"wall"}]},panel:{x:e.padding*2+e.grid_size*16,y:e.padding,map:{grid_x:3,grid_y:3,x:0,y:110,grids_cfg:[{pos:[0,0],building:"cannon"},{pos:[1,0],building:"LMG"},{pos:[2,0],building:"HMG"},{pos:[0,1],building:"laser_gun"},{pos:[2,2],building:"wall"}]}},config:{endless:true,wait_new_wave:100,difficulty:1,wave:0,max_wave:-1,wave_damage:0,
max_monsters_per_wave:100,money:500,score:0,life:100,waves:[[],[[1,0]],[[1,0],[1,1]],[[2,0],[1,1]],[[2,0],[1,1]],[[3,0],[2,1]],[[4,0],[2,1]],[[5,0],[3,1],[1,2]],[[6,0],[4,1],[1,2]],[[7,0],[3,1],[2,2]],[[8,0],[4,1],[3,2]]]},newWave:function(b){b=b||{};var c=b.map;b=b.wave||1;var g=e.wave_damage||0;if(b!=1)if(g==0)e.difficulty*=b<5?1.05:e.difficulty>20?1.05:e.difficulty>10?1.1:1.2;else if(e.wave_damage>=50)e.difficulty*=0.7;else if(e.wave_damage>=20)e.difficulty*=0.8;else if(e.wave_damage>=10)e.difficulty*=
0.9;else if(b>=10)e.difficulty*=1.05;e.log("wave "+b+", last wave damage = "+g+", difficulty = "+e.difficulty);b=this.config.waves[b]||e.makeMonsters(Math.min(Math.floor(Math.pow(b,1.1)),this.config.max_monsters_per_wave));c.addMonsters2(b);e.wave_damage=0}}}[a]||{}}});
_TD.a.push(function(e){e.default_upgrade_rule=function(f,d){return d*1.2};e.getDefaultBuildingAttributes=function(f){return{wall:{damage:0,range:0,speed:0,bullet_speed:0,life:100,shield:500,cost:5},cannon:{damage:8,range:4,max_range:8,speed:2,bullet_speed:6,life:100,shield:100,cost:300},LMG:{damage:3,range:6,max_range:10,speed:3,bullet_speed:6,life:100,shield:50,cost:100},HMG:{damage:10,range:3,max_range:6,speed:3,bullet_speed:5,life:100,shield:200,cost:800},laser_gun:{damage:25,range:9,max_range:10,
speed:20,life:100,shield:100,cost:2E3}}[f]||{}}});
_TD.a.push(function(e){function f(){if(this.is_valid&&this.grid){var d=e.ctx;d.strokeStyle="#000";d.lineWidth=1;d.fillStyle=this.color;d.beginPath();d.arc(this.cx,this.cy,this.r,0,Math.PI*2,true);d.closePath();d.fill();d.stroke();if(e.show_monster_life){var a=Math.floor(e.grid_size/4),b=a*2-2;d.fillStyle="#000";d.beginPath();d.fillRect(this.cx-a,this.cy-this.r-6,a*2,4);d.closePath();d.fillStyle="#f00";d.beginPath();d.fillRect(this.cx-a+1,this.cy-this.r-5,this.life*b/this.life0,2);d.closePath()}}}
e.getDefaultMonsterAttributes=function(d){var a=[{name:"monster 1",desc:"\u6700\u5f31\u5c0f\u7684\u602a\u7269",speed:3,max_speed:10,life:50,damage:1,shield:0,money:5},{name:"monster 2",desc:"\u7a0d\u5f3a\u4e00\u4e9b\u7684\u5c0f\u602a",speed:6,max_speed:20,life:50,damage:5,shield:1},{name:"monster speed",desc:"\u901f\u5ea6\u8f83\u5feb\u7684\u5c0f\u602a",speed:12,max_speed:30,life:50,damage:6,shield:1},{name:"monster life",desc:"\u751f\u547d\u503c\u5f88\u5f3a\u7684\u5c0f\u602a",speed:5,max_speed:10,
life:500,damage:7,shield:1},{name:"monster shield",desc:"\u9632\u5fa1\u5f88\u5f3a\u7684\u5c0f\u602a",speed:5,max_speed:10,life:50,damage:7,shield:100},{name:"monster damage",desc:"\u4f24\u5bb3\u503c\u5f88\u5927\u7684\u5c0f\u602a",speed:7,max_speed:14,life:50,damage:15,shield:2},{name:"monster speed-life",desc:"\u901f\u5ea6\u3001\u751f\u547d\u90fd\u8f83\u9ad8\u7684\u602a\u7269",speed:15,max_speed:30,life:100,damage:5,shield:3},{name:"monster speed-2",desc:"\u901f\u5ea6\u5f88\u5feb\u7684\u602a\u7269",
speed:30,max_speed:40,life:30,damage:5,shield:1}];if(typeof d=="undefined")return a.length;var b={};e.lang.mix(b,a[d]||a[0]);if(!b.render)b.render=f;return b};e.makeMonsters=function(d,a){var b=[],c=0,g,h,i;if(!a){a=[];for(g=0;g<e.monster_type_count;g++)a.push(g)}for(g=a.length;c<d;){h=d-c;h=Math.floor(Math.random()*h)+1;i=Math.floor(Math.random()*g);b.push([h,a[i]]);c+=h}return b}});
_TD.a.push(function(e){function f(a,b,c,g,h,i){var j,m,k,l;if(b==g){g=b;h=h>c?c+i:c-i}else if(c==h){h=c;g=g>b?b+i:b-i}else{h=(c-h)/(b-g);j=c-b*h;k=h*h+1;l=2*(h*(j-c)-b);i=Math.pow(j-c,2)+b*b-Math.pow(i,2);i=Math.pow(l,2)-4*k*i;if(i<0)return[0,0];i=Math.sqrt(i);m=(-l+i)/(2*k);g=g-b>0&&m-b>0||g-b<0&&m-b<0?m:(-l-i)/(2*k);h=h*g+j}a.lineCap="round";a.moveTo(b,c);a.lineTo(g,h);return[g,h]}var d={cannon:function(a,b,c,g,h){c=a.getTargetPosition();b.fillStyle="#393";b.strokeStyle="#000";b.beginPath();b.lineWidth=
1;b.arc(a.cx,a.cy,h-5,0,Math.PI*2,true);b.closePath();b.fill();b.stroke();b.fillStyle="#060";b.beginPath();b.arc(a.cx,a.cy,7,0,Math.PI*2,true);b.closePath();b.fill();b.stroke();b.fillStyle="#000";b.beginPath();b.arc(a.cx,a.cy,3,0,Math.PI*2,true);b.closePath();b.fill();b.lineWidth=3;b.beginPath();b.moveTo(a.cx,a.cy);a.muzzle=f(b,a.cx,a.cy,c[0],c[1],h);b.closePath();b.fill();b.stroke()},LMG:function(a,b,c,g,h){c=a.getTargetPosition();b.fillStyle="#36f";b.strokeStyle="#000";b.beginPath();b.lineWidth=
1;b.arc(a.cx,a.cy,7,0,Math.PI*2,true);b.closePath();b.fill();b.stroke();b.fillStyle="#060";b.beginPath();b.arc(a.cx,a.cy,5,0,Math.PI*2,true);b.closePath();b.fill();b.stroke();b.fillStyle="#000";b.beginPath();b.arc(a.cx,a.cy,3,0,Math.PI*2,true);b.closePath();b.fill();b.lineWidth=2;b.beginPath();b.moveTo(a.cx,a.cy);a.muzzle=f(b,a.cx,a.cy,c[0],c[1],h);b.closePath();b.fill();b.stroke()},HMG:function(a,b,c,g,h){c=a.getTargetPosition();b.fillStyle="#933";b.strokeStyle="#000";b.beginPath();b.lineWidth=1;
b.arc(a.cx,a.cy,h-2,0,Math.PI*2,true);b.closePath();b.fill();b.stroke();b.fillStyle="#630";b.beginPath();b.arc(a.cx,a.cy,h-5,0,Math.PI*2,true);b.closePath();b.fill();b.stroke();b.fillStyle="#000";b.beginPath();b.arc(a.cx,a.cy,4,0,Math.PI*2,true);b.closePath();b.fill();b.lineWidth=5;b.beginPath();b.moveTo(a.cx,a.cy);a.muzzle=f(b,a.cx,a.cy,c[0],c[1],h);b.closePath();b.fill();b.stroke()},wall:function(a,b,c,g,h){b.lineWidth=1;b.fillStyle="#666";b.strokeStyle="#000";b.fillRect(a.cx-h+1,a.cy-h+1,g-1,g-
1);b.beginPath();b.moveTo(a.cx-h+0.5,a.cy-h+0.5);b.lineTo(a.cx-h+0.5,a.cy+h+0.5);b.lineTo(a.cx+h+0.5,a.cy+h+0.5);b.lineTo(a.cx+h+0.5,a.cy-h+0.5);b.lineTo(a.cx-h+0.5,a.cy-h+0.5);b.moveTo(a.cx-h+0.5,a.cy+h+0.5);b.lineTo(a.cx+h+0.5,a.cy-h+0.5);b.moveTo(a.cx-h+0.5,a.cy-h+0.5);b.lineTo(a.cx+h+0.5,a.cy+h+0.5);b.closePath();b.stroke()},laser_gun:function(a,b){b.fillStyle="#f00";b.strokeStyle="#000";b.beginPath();b.lineWidth=1;b.moveTo(a.cx,a.cy-10);b.lineTo(a.cx-8.66,a.cy+5);b.lineTo(a.cx+8.66,a.cy+5);b.lineTo(a.cx,
a.cy-10);b.closePath();b.fill();b.stroke();b.fillStyle="#60f";b.beginPath();b.arc(a.cx,a.cy,7,0,Math.PI*2,true);b.closePath();b.fill();b.stroke();b.fillStyle="#000";b.beginPath();b.arc(a.cx,a.cy,3,0,Math.PI*2,true);b.closePath();b.fill();b.lineWidth=3;b.beginPath();b.moveTo(a.cx,a.cy);b.closePath();b.fill();b.stroke()}};e.renderBuilding=function(a){(d[a.type]||d.wall)(a,e.ctx,a.map,e.grid_size,e.grid_size/2)}});
_TD.a.push(function(e){e._msg_texts={_cant_build:"\u4e0d\u80fd\u5728\u8fd9\u513f\u4fee\u5efa",_cant_pass:"\u602a\u7269\u4e0d\u80fd\u901a\u8fc7\u8fd9\u513f",entrance:"\u8d77\u70b9",exit:"\u7ec8\u70b9",not_enough_money:"\u91d1\u94b1\u4e0d\u8db3\uff0c\u9700\u8981 $${0}\uff01",wave_info:"\u7b2c ${0} \u6ce2",panel_money_title:"\u91d1\u94b1: ",panel_score_title:"\u79ef\u5206: ",panel_life_title:"\u751f\u547d: ",panel_building_title:"\u5efa\u7b51: ",panel_monster_title:"\u602a\u7269: ",building_name_wall:"\u8def\u969c",
building_name_cannon:"\u70ae\u53f0",building_name_LMG:"\u8f7b\u673a\u67aa",building_name_HMG:"\u91cd\u673a\u67aa",building_name_laser_gun:"\u6fc0\u5149\u70ae",building_info:"${0}: \u7b49\u7ea7 ${1}\uff0c\u653b\u51fb ${2}\uff0c\u901f\u5ea6 ${3}\uff0c\u5c04\u7a0b ${4}\uff0c\u6218\u7ee9 ${5}",building_info_wall:"${0}",building_intro_wall:"\u8def\u969c \u53ef\u4ee5\u963b\u6b62\u602a\u7269\u901a\u8fc7 ($${0})",building_intro_cannon:"\u70ae\u53f0 \u5c04\u7a0b\u3001\u6740\u4f24\u529b\u8f83\u4e3a\u5e73\u8861 ($${0})",
building_intro_LMG:"\u8f7b\u673a\u67aa \u5c04\u7a0b\u8f83\u8fdc\uff0c\u6740\u4f24\u529b\u4e00\u822c ($${0})",building_intro_HMG:"\u91cd\u673a\u67aa \u5feb\u901f\u5c04\u51fb\uff0c\u5a01\u529b\u8f83\u5927\uff0c\u5c04\u7a0b\u4e00\u822c ($${0})",building_intro_laser_gun:"\u6fc0\u5149\u67aa \u4f24\u5bb3\u8f83\u5927\uff0c\u547d\u4e2d\u7387 100% ($${0})",click_to_build:"\u5de6\u952e\u70b9\u51fb\u5efa\u9020 ${0} ($${1})",upgrade:"\u5347\u7ea7 ${0} \u5230 ${1} \u7ea7\uff0c\u9700\u82b1\u8d39 $${2}\u3002",sell:"\u51fa\u552e ${0}\uff0c\u53ef\u83b7\u5f97 $${1}",
upgrade_success:"\u5347\u7ea7\u6210\u529f\uff0c${0} \u5df2\u5347\u7ea7\u5230 ${1} \u7ea7\uff01\u4e0b\u6b21\u5347\u7ea7\u9700\u8981 $${2}\u3002",button_upgrade_text:"\u5347\u7ea7",button_sell_text:"\u51fa\u552e",button_start_text:"\u5f00\u59cb",button_restart_text:"\u91cd\u65b0\u5f00\u59cb",button_pause_text:"\u6682\u505c",button_continue_text:"\u7ee7\u7eed",button_pause_desc_0:"\u6e38\u620f\u6682\u505c",button_pause_desc_1:"\u6e38\u620f\u7ee7\u7eed",blocked:"\u4e0d\u80fd\u5728\u8fd9\u513f\u4fee\u5efa\u9053\u8def\uff0c\u8d77\u70b9\u4e0e\u7ec8\u70b9\u4e4b\u95f4\u81f3\u5c11\u8981\u6709\u4e00\u6761\u8def\u53ef\u5230\u8fbe\uff01",
_:"ERROR"};e._t=e.translate=function(f,d){d=typeof d=="object"&&d.constructor==Array?d:[];var a=this._msg_texts[f]||this._msg_texts._,b,c=d.length;for(b=0;b<c;b++)a=a.replace("${"+b+"}",d[b]);return a}});
_TD.a.push(function(e){e.FindWay=function(f,d,a,b,c,g,h){this.m=[];this.w=f;this.h=d;this.x1=a;this.y1=b;this.x2=c;this.y2=g;this.way=[];this.len=this.w*this.h;this.is_blocked=this.is_arrived=false;this.fPassable=typeof h=="function"?h:function(){return true};this._init()};e.FindWay.prototype={_init:function(){if(this.x1==this.x2&&this.y1==this.y2){this.is_arrived=true;this.way=[[this.x1,this.y1]]}else{for(var f=0;f<this.len;f++)this.m[f]=-2;this.x=this.x1;this.y=this.y1;this.distance=0;this.current=
[[this.x,this.y]];for(this.setVal(this.x,this.y,0);this.next(););}},getVal:function(f,d){var a=d*this.w+f;return a<this.len?this.m[a]:-1},setVal:function(f,d,a){f=d*this.w+f;if(f>this.len)return false;this.m[f]=a},getNeighborsOf:function(f,d){var a=[];d>0&&a.push([f,d-1]);f<this.w-1&&a.push([f+1,d]);d<this.h-1&&a.push([f,d+1]);f>0&&a.push([f-1,d]);return a},getAllNeighbors:function(){var f=[],d,a,b=this.current.length;for(a=0;a<b;a++){d=this.current[a];d=this.getNeighborsOf(d[0],d[1]);f=f.concat(d)}return f},
findWay:function(){for(var f=this.x2,d=this.y2,a=this.len,b,c,g,h=-1;(f!=this.x1||d!=this.y1)&&h!=0&&this.way.length<a;){this.way.unshift([f,d]);c=this.getNeighborsOf(f,d);b=c.length;f=[];h=-1;for(g=0;g<b;g++){d=this.getVal(c[g][0],c[g][1]);if(!(d<0))if(h<0||h>d)h=d}for(g=0;g<b;g++){d=c[g];h==this.getVal(d[0],d[1])&&f.push(d)}d=f.length;g=d>1?Math.floor(Math.random()*d):0;d=f[g];f=d[0];d=d[1]}},arrive:function(){this.current=[];this.is_arrived=true;this.findWay()},blocked:function(){this.current=
[];this.is_blocked=true},next:function(){var f=this.getAllNeighbors(),d,a=f.length,b=[],c,g,h,i;this.distance++;for(h=0;h<a;h++){d=f[h];c=d[0];g=d[1];if(this.getVal(c,g)==-2){if(this.fPassable(c,g)){i=this.distance;b.push(d)}else i=-1;this.setVal(c,g,i);if(c==this.x2&&g==this.y2){this.arrive();return false}}}if(b.length==0){this.blocked();return false}this.current=b;return true}}});
